{% extends "base.html" %}
{% block title %}Downloads - FB Monitor{% endblock %}
{% block content %}
<h1>Media Downloads</h1>

<div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
    <a href="/downloads?status=pending"
       style="padding: 0.4rem 0.75rem; border-radius: 6px; font-size: 0.9rem;
              {% if status == 'pending' %}background: var(--accent); color: white;{% else %}background: var(--surface2); color: var(--text-dim);{% endif %}">
        Pending ({{ counts.pending }})
    </a>
    <a href="/downloads?status=downloaded"
       style="padding: 0.4rem 0.75rem; border-radius: 6px; font-size: 0.9rem;
              {% if status == 'downloaded' %}background: var(--green); color: white;{% else %}background: var(--surface2); color: var(--text-dim);{% endif %}">
        Downloaded ({{ counts.downloaded }})
    </a>
    <a href="/downloads?status=skipped"
       style="padding: 0.4rem 0.75rem; border-radius: 6px; font-size: 0.9rem;
              {% if status == 'skipped' %}background: var(--text-dim); color: var(--bg);{% else %}background: var(--surface2); color: var(--text-dim);{% endif %}">
        Skipped ({{ counts.skipped }})
    </a>
</div>

{% if status == 'pending' and pending_videos > 0 %}
<div class="card" style="margin-bottom: 1.5rem; border: 1px solid var(--accent);">
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
        <div>
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Batch Video Download</div>
            <div style="font-size: 0.85rem; color: var(--text-dim);">
                {{ pending_videos }} pending video{{ 's' if pending_videos != 1 else '' }}.
                Downloads one at a time with random delays to avoid detection.
            </div>
            {% if batch_state.running %}
            <div style="font-size: 0.85rem; color: var(--green); margin-top: 0.25rem;">
                Running: {{ batch_state.downloaded }}/{{ batch_state.total }} downloaded
                {% if batch_state.current %} â€” {{ batch_state.current }}{% endif %}
            </div>
            {% endif %}
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            {% if batch_state.running %}
            <form method="post" action="/downloads/batch-stop">
                <button type="submit" style="background: #e05555; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                    Stop
                </button>
            </form>
            {% else %}
            <form method="post" action="/downloads/batch-videos" style="display: flex; gap: 0.5rem; align-items: center;">
                <label style="font-size: 0.8rem; color: var(--text-dim);">Delay:</label>
                <select name="min_delay" style="padding: 0.3rem; border-radius: 4px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-size: 0.8rem;">
                    <option value="60">1 min</option>
                    <option value="300" selected>5 min</option>
                    <option value="900">15 min</option>
                    <option value="3600">1 hr</option>
                </select>
                <span style="font-size: 0.8rem; color: var(--text-dim);">to</span>
                <select name="max_delay" style="padding: 0.3rem; border-radius: 4px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-size: 0.8rem;">
                    <option value="300">5 min</option>
                    <option value="1800" selected>30 min</option>
                    <option value="3600">1 hr</option>
                    <option value="7200">2 hr</option>
                    <option value="14400">4 hr</option>
                </select>
                <button type="submit" style="background: var(--accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">
                    Download All Videos
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if items %}
{% for item in items %}
<div class="card" style="display: flex; gap: 1rem; align-items: center;">
    <div style="flex-shrink: 0; width: 60px; text-align: center;">
        {% if item.type == 'image' %}
        <div style="font-size: 2rem;">&#128247;</div>
        <div style="font-size: 0.7rem; color: var(--text-dim);">Image</div>
        {% else %}
        <div style="font-size: 2rem;">&#127909;</div>
        <div style="font-size: 0.7rem; color: var(--text-dim);">Video</div>
        {% endif %}
    </div>

    <div style="flex: 1; min-width: 0;">
        <div style="font-size: 0.85rem;">
            <a href="/posts/{{ item.post_id | urlencode }}">
                <span style="color: var(--accent);">{{ item.page_name }}</span>
            </a>
            <span style="color: var(--text-dim); margin-left: 0.5rem;">[{{ item.account }}]</span>
            <span style="color: var(--text-dim); margin-left: 0.5rem;">{{ item.created_at[:16] }}</span>
        </div>
        <div style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            {{ item.post_text[:120] if item.post_text else "(no text)" }}
        </div>
        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            {{ item.url[:100] }}{% if item.url|length > 100 %}...{% endif %}
        </div>
        {% if item.status == 'downloaded' and item.local_path %}
        <div style="font-size: 0.75rem; color: var(--green); margin-top: 0.25rem;">
            Saved: {{ item.local_path }}
        </div>
        {% endif %}
    </div>

    <div style="flex-shrink: 0; display: flex; gap: 0.5rem;">
        {% if item.status == 'pending' %}
        <form method="post" action="/downloads/{{ item.id }}/download" style="display: inline;">
            <button type="submit" style="background: var(--accent); color: white; border: none; padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                Download
            </button>
        </form>
        <form method="post" action="/downloads/{{ item.id }}/skip" style="display: inline;">
            <button type="submit" style="background: none; color: var(--text-dim); border: 1px solid var(--border); padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                Skip
            </button>
        </form>
        {% elif item.status == 'downloaded' %}
        <span style="color: var(--green); font-size: 0.85rem;">Downloaded</span>
        {% elif item.status == 'skipped' %}
        <form method="post" action="/downloads/{{ item.id }}/download" style="display: inline;">
            <button type="submit" style="background: var(--surface2); color: var(--text); border: 1px solid var(--border); padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                Download anyway
            </button>
        </form>
        {% endif %}
    </div>
</div>
{% endfor %}

{% if items|length >= 100 %}
<div style="text-align: center; padding: 1rem; color: var(--text-dim);">
    Showing first 100 items.
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p>No {{ status }} media items.</p>
    {% if status == 'pending' %}
    <p style="font-size: 0.9rem;">Media from logged-in accounts will appear here for manual download review.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}
